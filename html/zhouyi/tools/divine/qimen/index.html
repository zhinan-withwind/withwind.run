<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¥‡é—¨èµ·å¦å·¥å…· | éšé£</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header and Navigation will be loaded by common.js -->
    
    <!-- Main Content -->
    <section class="min-h-screen pt-20 pb-12 px-8">
        <div class="max-w-4xl mx-auto">
            <!-- Title -->
            <div class="text-center mb-12 fade-in">
                <h1 class="text-4xl md:text-5xl font-light mb-4">å¥‡é—¨èµ·å¦å·¥å…·</h1>
                <p class="text-gray-600 text-lg">è¾“å…¥ä¸ªäººä¿¡æ¯ï¼Œç”Ÿæˆæ‚¨çš„å¥‡é—¨éç”²å‘½ç›˜</p>
            </div>
            
            <!-- Form Section -->
            <div class="bg-white border border-gray-200 rounded-lg p-8 mb-8 fade-in">
                <form id="divineForm" class="space-y-6">
                    <!-- Name Input -->
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                            å§“å <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="name" name="name" required
                               class="w-full px-4 py-2 border border-gray-300 focus:ring-1 focus:ring-black focus:border-black outline-none transition-colors"
                               placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
                    </div>
                    
                    <!-- Birthday DateTime -->
                    <div>
                        <label for="birthday" class="block text-sm font-medium text-gray-700 mb-2">
                            ç”Ÿæ—¥ <span class="text-red-500">*</span>
                        </label>
                        <input type="datetime-local" id="birthday" name="birthday" required
                               class="w-full px-4 py-2 border border-gray-300 focus:ring-1 focus:ring-black focus:border-black outline-none transition-colors">
                    </div>
                    
                    <!-- Sex Selection -->
                    <div>
                        <label for="sex" class="block text-sm font-medium text-gray-700 mb-2">
                            æ€§åˆ« <span class="text-red-500">*</span>
                        </label>
                        <select id="sex" name="sex" required
                                class="w-full px-4 py-2 border border-gray-300 focus:ring-1 focus:ring-black focus:border-black outline-none transition-colors">
                            <option value="">è¯·é€‰æ‹©æ€§åˆ«</option>
                            <option value="1">ç”·</option>
                            <option value="0">å¥³</option>
                        </select>
                    </div>
                    
                    <!-- Region Input -->
                    <div>
                        <label for="region" class="block text-sm font-medium text-gray-700 mb-2">
                            åœ°åŒº <span class="text-gray-400">ï¼ˆé€‰å¡«ï¼‰</span>
                        </label>
                        <input type="text" id="region" name="region"
                               class="w-full px-4 py-2 border border-gray-300 focus:ring-1 focus:ring-black focus:border-black outline-none transition-colors"
                               placeholder="è¯·è¾“å…¥æ‚¨çš„åœ°åŒºï¼Œå¦‚ï¼šåŒ—äº¬ï¼Œä¸Šæµ·ç­‰ç­‰">
                    </div>
                    
                    <!-- Submit Button -->
                    <div class="pt-4">
                        <button type="submit" 
                                class="w-full bg-black text-white py-3 px-6 hover:bg-gray-800 transition-colors duration-200 font-light">
                            å¼€å§‹æ’ç›˜
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Loading State -->
            <div id="loadingSection" class="hidden text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-black mb-4"></div>
                <p class="text-gray-600">æ­£åœ¨ç”Ÿæˆå¥‡é—¨å‘½ç›˜ï¼Œè¯·ç¨å€™...</p>
            </div>
            
            <!-- Results Section -->
            <div id="resultsSection" class="hidden space-y-8 fade-in">
                <!-- Chart Image -->
                <div id="chartSection" class="hidden">
                    <h2 class="text-2xl font-light mb-6 text-center">å¥‡é—¨å‘½ç›˜å›¾</h2>
                    <div class="text-center">
                        <img id="chartImage" src="" alt="å¥‡é—¨å‘½ç›˜å›¾" 
                             class="max-w-full mx-auto border border-gray-200 rounded-lg shadow-sm">
                    </div>
                </div>
                
                <!-- Analysis Data -->
                <div id="analysisSection" class="hidden">
                    <h2 class="text-2xl font-light mb-6 text-center">å‘½ç›˜åˆ†æ</h2>
                    <div id="analysisContent" class="bg-white border border-gray-200 rounded-lg p-8 text-gray-700 leading-relaxed">
                        <!-- Analysis data will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    
    <script>
        // Form submission handler
        document.getElementById('divineForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('name').value,
                birthday: document.getElementById('birthday').value,
                sex: document.getElementById('sex').value,
                region: document.getElementById('region').value
            };
            
            // Validate required fields are filled
            if (!formData.name || !formData.birthday || !formData.sex) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µï¼ˆå§“åã€ç”Ÿæ—¥ã€æ€§åˆ«ï¼‰');
                return;
            }
            
            // Show loading
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            
            try {
                // Convert birthday to proper format for API
                const birthdayDate = new Date(formData.birthday);
                
                // Format for Chart API: YYYY-MM-DDTHH:mm
                const chartTimeFormat = birthdayDate.toISOString().slice(0, 16);
                
                // Format for Analysis API: YYYY-MM-DD HH:mm
                const year = birthdayDate.getFullYear();
                const month = String(birthdayDate.getMonth() + 1).padStart(2, '0');
                const day = String(birthdayDate.getDate()).padStart(2, '0');
                const hour = String(birthdayDate.getHours()).padStart(2, '0');
                const minute = String(birthdayDate.getMinutes()).padStart(2, '0');
                const analysisTimeFormat = `${year}-${month}-${day} ${hour}:${minute}`;
                
                // Debug: Log form data
                console.log('ğŸ“¤ Form Data:', formData);
                console.log('ğŸ• Chart Time Format:', chartTimeFormat);
                console.log('ğŸ• Analysis Time Format:', analysisTimeFormat);
                
                // Determine API URLs based on environment
                const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                console.log('ğŸŒ Environment:', isLocalDev ? 'Local Development' : 'Production');
                
                let chartUrl, analysisUrl;
                
                if (isLocalDev) {
                    // Use local proxy in development
                    chartUrl = `/api/zhouyi/qimen/divine/chart?divineTime=${encodeURIComponent(chartTimeFormat)}`;
                    analysisUrl = `/api/zhouyi/qimen/analyzeForJiang?name=${encodeURIComponent(formData.name)}&birthday=${encodeURIComponent(analysisTimeFormat)}&region=${encodeURIComponent(formData.region)}&sex=${encodeURIComponent(formData.sex)}`;
                } else {
                    // Use direct API in production
                    chartUrl = `https://app.withwind.run/zhouyi/qimen/divine/chart?divineTime=${encodeURIComponent(chartTimeFormat)}`;
                    analysisUrl = `https://app.withwind.run/zhouyi/qimen/analyzeForJiang?name=${encodeURIComponent(formData.name)}&birthday=${encodeURIComponent(analysisTimeFormat)}&region=${encodeURIComponent(formData.region)}&sex=${encodeURIComponent(formData.sex)}`;
                }
                
                console.log('ğŸ”— Chart URL:', chartUrl);
                console.log('ğŸ”— Analysis URL:', analysisUrl);
                
                // Make API calls in parallel
                const [chartResponse, analysisResponse] = await Promise.all([
                    fetch(chartUrl),
                    fetch(analysisUrl)
                ]);
                
                console.log('ğŸ“Š Chart Response Status:', chartResponse.status, chartResponse.statusText);
                console.log('ğŸ“Š Analysis Response Status:', analysisResponse.status, analysisResponse.statusText);
                
                // Handle chart image
                if (chartResponse.ok) {
                    console.log('âœ… Chart API successful');
                    const chartBlob = await chartResponse.blob();
                    console.log('ğŸ–¼ï¸ Chart blob size:', chartBlob.size, 'bytes');
                    
                    if (chartBlob.size > 0) {
                        const chartImageUrl = URL.createObjectURL(chartBlob);
                        document.getElementById('chartImage').src = chartImageUrl;
                        document.getElementById('chartSection').classList.remove('hidden');
                    } else {
                        console.warn('âš ï¸ Chart image is empty');
                    }
                } else {
                    console.error('âŒ Chart API failed:', chartResponse.status, chartResponse.statusText);
                    const errorText = await chartResponse.text();
                    console.error('Chart Error Response:', errorText);
                }
                
                // Handle analysis data
                if (analysisResponse.ok) {
                    console.log('âœ… Analysis API successful');
                    const analysisData = await analysisResponse.json();
                    console.log('ğŸ“‹ Analysis Data:', analysisData);
                    
                    displayAnalysisData(analysisData);
                    document.getElementById('analysisSection').classList.remove('hidden');
                } else {
                    console.error('âŒ Analysis API failed:', analysisResponse.status, analysisResponse.statusText);
                    const errorText = await analysisResponse.text();
                    console.error('Analysis Error Response:', errorText);
                }
                
                // Show results and hide loading
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('resultsSection').classList.remove('hidden');
                
            } catch (error) {
                console.error('ğŸ’¥ API request failed:', error);
                document.getElementById('loadingSection').classList.add('hidden');
                alert('æ’ç›˜è¯·æ±‚å¤±è´¥ï¼š' + error.message);
            }
        });
        
        function displayAnalysisData(data) {
            console.log('ğŸ¨ å¼€å§‹è§£ææ•°æ®:', data);
            const content = document.getElementById('analysisContent');
            let html = '';
            
            // å¦‚æœæ•°æ®ä¸ºç©ºæˆ–æ— æ•ˆï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            if (!data || (typeof data !== 'object')) {
                console.warn('âš ï¸ æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯:', data);
                html = '<p class="text-center text-gray-500 py-8">æš‚æ— åˆ†ææ•°æ®ï¼Œè¯·ç¨åé‡è¯•</p>';
                content.innerHTML = html;
                return;
            }
            
            // Basic info
            if (data.baseInfo) {
                const base = data.baseInfo;
                html += `<div class="mb-8"><h3 class="text-xl font-light mb-4">${base.personName || ''}ï¼ˆ${base.sex || ''}ï¼‰å¥‡é—¨éç”²å‘½ç›˜æ’ç›˜ä¿¡æ¯ï¼š</h3>`;
                
                html += '<div class="space-y-2">';
                html += `<p><strong>1ã€åŸºæœ¬ä¿¡æ¯ï¼š</strong></p>`;
                
                if (base.solarBirthday) {
                    html += `<p>å…¬å† ${base.solarBirthday}`;
                    if (base.lunarBirthday) {
                        html += `<br>å†œå† ${base.lunarBirthday}`;
                    }
                    if (base.apparentSolarTime) {
                        html += `<br>çœŸå¤ªé˜³æ—¶ ${base.apparentSolarTime}`;
                    }
                    html += '</p>';
                }
                
                if (base.ganZhiBirthday) {
                    html += '<p>å››æŸ±ï¼š';
                    html += `å¹´æŸ±/${base.ganZhiBirthday.ganZhiYear?.name || ''} `;
                    html += `æœˆæŸ±/${base.ganZhiBirthday.ganZhiMonth?.name || ''} `;
                    html += `æ—¥æŸ±/${base.ganZhiBirthday.ganZhiDay?.name || ''} `;
                    html += `æ—¶æŸ±/${base.ganZhiBirthday.ganZhiTime?.name || ''}`;
                    html += '</p>';
                }
                
                html += `<p>é€‰å±€ï¼š${base.pattern || ''}</p>`;
                html += `<p>æ—¬é¦–ï¼š${base.xunHead || ''}</p>`;
                html += `<p>å€¼ç¬¦ï¼š${base.dutyStar || ''}</p>`;
                html += `<p>å€¼ä½¿ï¼š${base.dutyDoor || ''}</p>`;
                
                if (data.layout || data.anchorPalace) {
                    html += `<p>å±€åŠ¿ï¼š${data.layout || ''}`;
                    if (data.layout && data.anchorPalace) html += '-';
                    if (data.anchorPalace) html += `å¯„${data.anchorPalace}`;
                    html += '</p>';
                }
                
                if (base.lastSolarTerm) {
                    html += `<p>ä¸Šä¸€ä¸ªèŠ‚æ°”ï¼š${base.lastSolarTerm.name || ''} ${base.lastSolarTerm.dateTime || ''}</p>`;
                }
                if (base.nextSolarTerm) {
                    html += `<p>ä¸‹ä¸€ä¸ªèŠ‚æ°”ï¼š${base.nextSolarTerm.name || ''} ${base.nextSolarTerm.dateTime || ''}</p>`;
                }
                
                html += '</div></div>';
            }
            
            // Palace info
            if (data.palaceInfo) {
                html += '<div><h3 class="text-xl font-light mb-4">2ã€å…«å®«ä¿¡æ¯ï¼š</h3><div class="space-y-2">';
                
                const orderSeq = ["å·½å››å®«", "ç¦»ä¹å®«", "å¤äºŒå®«", "å…‘ä¸ƒå®«", "ä¹¾å…­å®«", "åä¸€å®«", "è‰®å…«å®«", "éœ‡ä¸‰å®«"];
                
                orderSeq.forEach(palaceName => {
                    const palace = data.palaceInfo[palaceName];
                    if (palace) {
                        const doorName = palace.door?.fullName || palace.door?.name || '';
                        const starName = palace.star?.name || palace.star?.shortName || '';
                        const deityName = palace.deity?.name || palace.deity?.shortName || '';
                        const tGan = palace.heaven?.gan?.name || '';
                        const tStat = palace.heaven?.statuses || '';
                        const dGan = palace.ground?.gan?.name || '';
                        const dStat = palace.ground?.statuses || '';
                        
                        const isKongWang = (palace.isTimeEmpty || palace.isDayEmpty);
                        const isMaXing = palace.isHorse || false;
                        const isRuMu = (palace.ground?.isEnterTomb) || (dStat?.includes('å¢“'));
                        
                        html += `<p><strong>${palaceName}ï¼š</strong>${doorName}/${starName}/${deityName} å¤©${tGan}`;
                        if (tStat) html += `ã€${tStat}ã€‘`;
                        html += `/åœ°${dGan}`;
                        if (dStat) html += `ã€${dStat}ã€‘`;
                        if (isKongWang) html += ' ç©ºäº¡';
                        if (isMaXing) html += ' é©¬æ˜Ÿ';
                        if (isRuMu) html += ' å…¥å¢“';
                        html += '</p>';
                    }
                });
                
                html += '</div></div>';
            }
            
            console.log('ğŸ“ ç”Ÿæˆçš„HTMLé•¿åº¦:', html.length);
            
            if (html.trim()) {
                content.innerHTML = html;
                console.log('âœ… æ•°æ®è§£æå®Œæˆå¹¶æ˜¾ç¤º');
            } else {
                console.warn('âš ï¸ ç”Ÿæˆçš„HTMLä¸ºç©º');
                content.innerHTML = '<p class="text-center text-gray-500 py-8">æš‚æ— åˆ†ææ•°æ®</p>';
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            
            // Initialize fade-in animations
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };
            
            const observer = new IntersectionObserver(function(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, observerOptions);
            
            document.querySelectorAll('.fade-in').forEach(el => {
                observer.observe(el);
            });
        });
    </script>
</body>
</html>